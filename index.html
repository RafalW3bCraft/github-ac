<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
<title>INDEX-GAMBLER ‚Äî RafalW3bCraft</title>
<meta name="theme-color" content="#0a0f14"/>
<style>
:root{
  --bg:#070b10; --panel:#0c141e; --ink:#dff7ff; --muted:#86a9c2;
  --acc:#00ffc6; --acc2:#ff3d81; --gold:#ffd166; --good:#2af07a; --bad:#ff5050; --blue:#66c2ff;
  --edge:#193447; --edge2:#24546e; --glass:#0a1621cc;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink);
  background:
    radial-gradient(1400px 700px at 115% -10%, rgba(0,255,198,.10), transparent),
    radial-gradient(1100px 600px at -15% 110%, rgba(255,61,129,.10), transparent),
    #061018;
  font-family: Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Noto Color Emoji;
}
header{
  position:sticky; top:0; z-index:10;
  display:flex; align-items:center; gap:10px; padding:12px 14px;
  background:linear-gradient(180deg, #08121b 0%, #09131d 100%); border-bottom:1px solid var(--edge);
  box-shadow: 0 2px 18px rgba(0,0,0,.25);
}
.brand{display:flex; gap:10px; align-items:center}
.brand .logo{font-size:22px; filter: drop-shadow(0 0 8px rgba(0,255,198,.35))}
.brand h1{font-size:16px; margin:0; letter-spacing:.6px; color:var(--acc)}
header .right{margin-left:auto; display:flex; align-items:center; gap:8px}
.pill{padding:6px 10px; border:1px solid var(--edge2); border-radius:999px; background:#0c1a26; color:#aee6ff; font-size:12px}
.btn{cursor:pointer; border:1px solid var(--edge2); background:#0f1e2a; color:var(--ink); padding:10px 12px; border-radius:12px; transition:.15s transform}
.btn:active{transform:translateY(1px)}
.btn.primary{background:linear-gradient(180deg,#00ffc6,#00d3a7); border-color:#00dabb; color:#002c25; font-weight:800}
.btn.ghost{background:transparent}
.btn.warn{background:#2a1b0d; border-color:#76501a; color:#ffdca0}
.wrap{display:grid; grid-template-columns:1fr; gap:12px; padding:12px}
@media(min-width:1100px){ .wrap{grid-template-columns:300px 1fr 340px} }
.card{background:linear-gradient(180deg,#0a141d,#0b1721); border:1px solid var(--edge); border-radius:14px; overflow:hidden}
.card h2{margin:0; padding:10px 12px; border-bottom:1px dashed var(--edge2); font-size:13px; color:#92e7ff; letter-spacing:.6px}
.pad{padding:12px}
.row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
.col{display:flex; flex-direction:column; gap:10px}
.kpi{background:#08131c; border:1px solid var(--edge); border-radius:12px; padding:10px}
.score{font-size:24px; color:#c9fbff}
.sub{font-size:12px; color:var(--muted)}
.badge{font-size:11px; padding:6px 8px; border:1px solid var(--edge2); border-radius:10px; background:#0c1620}
hr.sep{border:0; border-top:1px dashed var(--edge2); margin:8px 0}
input,select{background:#0c1924; border:1px solid var(--edge2); border-radius:12px; color:#e6fbff; padding:10px; min-width:0}

/* Tabs */
.tabs{display:flex; gap:8px; flex-wrap:wrap}
.tab{flex:1; text-align:center; background:#0d1a26; border:1px solid var(--edge); border-radius:12px; padding:10px; cursor:pointer}
.tab.active{background:linear-gradient(180deg,#0d2330,#0b1c29); box-shadow:0 0 0 1px #1f5a76 inset}

/* Slots ‚Äî 5x3 */
.slotsHead{display:flex; align-items:flex-end; justify-content:space-between}
.reels{position:relative; height:280px; display:grid; grid-template-columns:repeat(5,1fr); gap:10px; margin:10px 0}
.reel{background:#07131c; border:1px solid var(--edge2); border-radius:12px; overflow:hidden; position:relative}
.strip{position:absolute; left:0; right:0; top:0; will-change:transform}
.cell{height:90px; display:grid; place-items:center; font-size:34px; text-shadow:0 0 10px rgba(255,255,255,.15)}
.payline{position:absolute; left:0; right:0; height:2px; background:linear-gradient(90deg, transparent, var(--gold), transparent); opacity:.35; pointer-events:none}
.winGlow{box-shadow:0 0 0 1px #ffe29e inset, 0 0 18px rgba(255,209,102,.35); animation:glow .9s ease-in-out infinite alternate}
@keyframes glow{from{box-shadow:0 0 0 1px #ffe29e inset, 0 0 10px rgba(255,209,102,.2)}to{box-shadow:0 0 0 1px #ffe29e inset, 0 0 26px rgba(255,209,102,.5)}}
.bigWin{font-size:36px; color:#ffe29e; text-shadow:0 0 14px rgba(255,209,102,.5)}
.payTable{font-size:12px}
.spark{position:absolute; width:8px; height:8px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #fff, #ffd166 45%, transparent 60%); pointer-events:none;}

/* Runner Rush */
.runnerWrap{position:relative; height:420px; border-radius:14px; overflow:hidden; border:1px solid var(--edge2); background:#061018}
canvas#runner{display:block; width:100%; height:420px; background:linear-gradient(#061018 60%, #0b1a26)}
.hud{position:absolute; top:8px; left:8px; right:8px; display:flex; justify-content:space-between; gap:8px; pointer-events:none}
.hud .tag{background:#0b1620aa; border:1px solid var(--edge2); padding:6px 10px; border-radius:10px}
.ctaRow{position:absolute; bottom:10px; left:0; right:0; display:flex; justify-content:center; gap:12px}
.gbtn{pointer-events:auto; padding:10px 12px; border-radius:12px; border:1px solid var(--edge2); background:#0f1e2a; color:#e8fbff}
.gbtn.primary{background:linear-gradient(180deg,#00ffc6,#00d3a7); color:#00332a; border-color:#00d3b7}

/* Leaderboard & log */
.log{max-height:280px; overflow:auto; font-size:12px}
.toast{position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#081620; color:#defcff; border:1px solid var(--edge2); border-radius:12px; padding:10px 14px; box-shadow:0 10px 30px rgba(0,0,0,.45); opacity:0; pointer-events:none; transition:.18s opacity,.18s transform; z-index:20}
.toast.show{opacity:1; transform:translateX(-50%) translateY(-6px)}

/* Theme toggle (subtle) */
.themeLight:root, .themeLight body{ --bg:#f7fbff; --panel:#ffffff; --ink:#0c1a22; --muted:#4a6b82; background:#eaf6ff }
.themeLight header{ background:#ffffffcc; }
.themeLight .card{ background:#ffffff; }
.themeLight .reel{ background:#f3faff }
.themeLight .pill{ background:#eef7ff }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">üé∞</div>
    <h1>GO-GAMBLER</h1>
    <div class="pill">by <b>RafalW3bCraft</b></div>
  </div>
  <div class="right">
    <div id="balancePill" class="pill">Balance: <b id="bal">‚Äî</b></div>
    <button id="themeBtn" class="btn ghost">üåó Theme</button>
    <button id="sfxBtn" class="btn ghost">üîä SFX</button>
  </div>
</header>

<div class="wrap">
  <!-- LEFT: Dashboard -->
  <section class="card">
    <h2>Casino Dashboard</h2>
    <div class="pad col">
      <div class="kpi">
        <div class="sub">Balance</div>
        <div id="balance" class="score">‚Äî</div>
      </div>
      <div class="row">
        <label class="sub">Bet per spin</label>
        <input id="bet" type="number" min="1" step="10" value="100" style="width:120px"/>
        <button id="betMax" class="btn">MAX</button>
        <button id="betHalf" class="btn">¬Ω</button>
        <button id="betDouble" class="btn">2√ó</button>
      </div>
      <div class="kpi">
        <div class="sub">Recent Wins</div>
        <div id="recent" class="log"></div>
      </div>
      <div class="kpi">
        <div class="sub">Local Leaderboard</div>
        <div id="lb" class="log"></div>
        <button id="saveLB" class="btn" style="margin-top:6px">Save Session ‚Üí Leaderboard</button>
      </div>
      <div class="kpi">
        <div class="sub">Missions</div>
        <div id="missions" class="col">
          <!-- populated by JS -->
        </div>
      </div>
    </div>
  </section>

  <!-- CENTER: Games -->
  <section class="card">
    <h2>Games</h2>
    <div class="pad">
      <div class="tabs">
        <div class="tab active" data-tab="slotsTab">üé≤ Neo Slots</div>
        <div class="tab" data-tab="runnerTab">üèÉ Runner Rush</div>
      </div>

      <!-- SLOTS -->
      <div id="slotsTab" class="col" style="margin-top:10px">
        <div class="slotsHead">
          <div>
            <div class="sub">Provably Fair</div>
            <div class="sub">Server Seed Hash: <span id="srvHash">‚Äî</span></div>
            <div class="sub">Client Seed: <span id="cliSeed">‚Äî</span></div>
            <div class="sub">Nonce: <span id="nonce">‚Äî</span></div>
          </div>
          <div style="text-align:right">
            <div class="sub">Payout</div>
            <div id="payoutBox" class="bigWin">‚Äî</div>
          </div>
        </div>

        <div class="reels" id="reels"></div>

        <div class="row">
          <button id="spinBtn" class="btn primary">SPIN</button>
          <button id="autoBtn" class="btn">Auto (25)</button>
          <span id="slotStatus" class="badge">Ready</span>
        </div>

        <div class="kpi">
          <div class="sub">Paytable & Lines</div>
          <div class="row">
            <div class="payTable">
              <b>Symbols:</b> üíé Wild (substitutes), ‚≠ê Scatter (free spins), üçí, üçã, üü©, üîî, 7Ô∏è‚É£<br/>
              5-of-a-kind pays: üíé√ó100, 7Ô∏è‚É£√ó50, üîî√ó25, üçí√ó15, üçã√ó10, üü©√ó5<br/>
              Any 3+ ‚≠ê scatters ‚Üí 8 free spins.
            </div>
          </div>
        </div>
      </div>

      <!-- RUNNER -->
      <div id="runnerTab" style="display:none; margin-top:10px">
        <div class="runnerWrap">
          <canvas id="runner" width="900" height="420"></canvas>
          <div class="hud">
            <div class="tag">Score: <b id="rScore">0</b></div>
            <div class="tag">Coins: <b id="rCoins">0</b></div>
            <div class="tag">Speed: <b id="rSpeed">1.0√ó</b></div>
          </div>
          <div class="ctaRow">
            <button id="rStart" class="gbtn primary">Start</button>
            <button id="rPause" class="gbtn">Pause</button>
            <button id="rHelp" class="gbtn">?</button>
          </div>
        </div>
        <div class="sub" style="margin-top:6px">Swipe / arrow keys: move lanes ¬∑ Swipe up/Space: jump ¬∑ Down: slide</div>
      </div>
    </div>
  </section>

  <!-- RIGHT: Activity & Settings -->
  <section class="card">
    <h2>Activity & Settings</h2>
    <div class="pad col">
      <div class="kpi">
        <div class="sub">Session Stats</div>
        <div class="row"><span class="badge">Spins: <b id="statSpins">0</b></span><span class="badge">RTP (est): <b id="statRTP">‚Äî</b></span><span class="badge">Biggest Win: <b id="statBig">0</b></span></div>
      </div>
      <div class="kpi">
        <div class="sub">Sound</div>
        <div class="row">
          <button id="sfxToggle" class="btn">üîä Toggle SFX</button>
          <button id="confettiTest" class="btn">‚ú® Test Particles</button>
        </div>
      </div>
      <div class="kpi">
        <div class="sub">Fairness Reveal (last spin)</div>
        <div class="sub">Server Seed: <span id="revealSrv">‚Äî</span></div>
      </div>
      <div class="kpi">
        <div class="sub">Reset / Export</div>
        <div class="row">
          <button id="resetAll" class="btn warn">Reset All</button>
          <button id="exportBtn" class="btn">Export Data</button>
          <input id="importFile" type="file" accept="application/json" style="display:none"/>
          <button id="importBtn" class="btn">Import</button>
        </div>
      </div>
    </div>
  </section>
</div>

<div id="toast" class="toast">Toast</div>

<script>
/* =========================
   Utils & SFX
========================= */
const $ = id=>document.getElementById(id);
const fmt = n => Number(n).toLocaleString();
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const rng = (min,max)=>Math.random()*(max-min)+min;

const toast=(m)=>{const t=$('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1400);};

let SFX_ON = true;
function beep(freq=880, dur=.06, type='triangle', vol=.18){
  if(!SFX_ON) return;
  const AC = new (window.AudioContext||window.webkitAudioContext)();
  const o = AC.createOscillator(), g = AC.createGain();
  o.type=type; o.frequency.value=freq; o.connect(g); g.connect(AC.destination);
  g.gain.value=0.0001; g.gain.exponentialRampToValueAtTime(vol, AC.currentTime+.01);
  g.gain.exponentialRampToValueAtTime(0.0001, AC.currentTime+dur);
  o.start(); o.stop(AC.currentTime+dur+.02);
}

/* =========================
   Persistence
========================= */
const STORE_KEY='gogambler_store_v2';
const store = {
  data: { bal:50000, bet:100, spins:0, won:0, biggest:0, history:[], leaderboard:[], theme:'dark', sfx:true, missions:{} },
  load(){ try{ const j=JSON.parse(localStorage.getItem(STORE_KEY)||'null'); if(j) this.data=j; }catch{} },
  save(){ localStorage.setItem(STORE_KEY, JSON.stringify(this.data)); },
  pushHistory(entry){ this.data.history.unshift(entry); this.data.history = this.data.history.slice(0,200); this.save(); renderRecent(); }
};

/* =========================
   Fairness (HMAC)
========================= */
const sha256=async s=>{
  const buf=new TextEncoder().encode(s);
  const h=await crypto.subtle.digest('SHA-256', buf);
  return [...new Uint8Array(h)].map(b=>b.toString(16).padStart(2,'0')).join('');
};
const hmac=async (key,msg)=>{
  const enc=new TextEncoder();
  const cryptoKey=await crypto.subtle.importKey('raw',enc.encode(key),{name:'HMAC',hash:'SHA-256'},false,['sign']);
  const sig=await crypto.subtle.sign('HMAC', cryptoKey, enc.encode(msg));
  return [...new Uint8Array(sig)].map(b=>b.toString(16).padStart(2,'0')).join('');
};
const uniFromHex = hex => {
  const slice = hex.slice(0,13);
  return parseInt(slice,16)/Math.pow(16,13);
};

const Fair = {
  serverSeed:'', serverHash:'', clientSeed:'', nonce:0,
  async newPack(){
    this.clientSeed = Math.random().toString(36).slice(2);
    this.serverSeed = Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2);
    this.serverHash = await sha256(this.serverSeed);
    this.nonce = 0;
    $('srvHash').textContent=this.serverHash;
    $('cliSeed').textContent=this.clientSeed;
    $('nonce').textContent=String(this.nonce);
  }
};

/* =========================
   UI Bindings
========================= */
const updateBal=()=>{ $('bal').textContent=fmt(store.data.bal); $('balance').textContent=fmt(store.data.bal); };
$('bet').oninput=e=>{ store.data.bet = Math.max(1,Math.floor(+e.target.value||0)); store.save(); };
$('betMax').onclick=()=>{ store.data.bet = store.data.bal; $('bet').value=store.data.bet; store.save(); };
$('betHalf').onclick=()=>{ store.data.bet = Math.max(1, Math.floor(store.data.bet/2)); $('bet').value=store.data.bet; store.save(); };
$('betDouble').onclick=()=>{ store.data.bet = Math.max(1, Math.floor(store.data.bet*2)); $('bet').value=store.data.bet; store.save(); };

$('saveLB').onclick=()=>{
  const score = store.data.bal;
  const row = { name:'Player', score, time: new Date().toLocaleString() };
  store.data.leaderboard.push(row);
  store.data.leaderboard.sort((a,b)=>b.score-a.score);
  store.data.leaderboard = store.data.leaderboard.slice(0,20);
  store.save(); renderLB(); toast('Session saved to leaderboard');
};
$('resetAll').onclick=()=>{
  if(!confirm('Reset all local data?')) return;
  localStorage.removeItem(STORE_KEY);
  store.load(); // reload defaults
  Fair.newPack();
  refreshAll();
  toast('Reset complete');
};
$('exportBtn').onclick=()=>{
  const blob = new Blob([JSON.stringify(store.data,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='go-gambler-export.json'; a.click(); URL.revokeObjectURL(a.href);
};
$('importBtn').onclick=()=>$('importFile').click();
$('importFile').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const fr=new FileReader(); fr.onload=()=>{
    try{ const j=JSON.parse(fr.result); if(j && typeof j==='object'){ store.data=j; store.save(); refreshAll(); toast('Imported successfully'); } }
    catch{ toast('Invalid file'); }
  }; fr.readAsText(f);
};

$('sfxBtn').onclick=()=>{ store.data.sfx=!store.data.sfx; SFX_ON=store.data.sfx; store.save(); toast(`SFX ${SFX_ON?'on':'off'}`); };
$('sfxToggle').onclick=()=>$('sfxBtn').click();
$('themeBtn').onclick=()=>{
  store.data.theme = store.data.theme==='dark'?'light':'dark';
  applyTheme();
  store.save();
};
function applyTheme(){
  if(store.data.theme==='light'){ document.documentElement.classList.add('themeLight'); }
  else{ document.documentElement.classList.remove('themeLight'); }
}

/* =========================
   Tabs
========================= */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
    const id = t.dataset.tab;
    ['slotsTab','runnerTab'].forEach(s=>$(s).style.display = (s===id)?(s==='slotsTab'?'block':''): 'none');
    if(id==='runnerTab'){ $('runnerTab').style.display='block'; }
  });
});

/* =========================
   Neo Slots (5√ó3, 10 lines, Wild/Scatter)
========================= */
const reelsEl = $('reels');
const ROWS=3, COLS=5, CELL_H=90;
const SYMS = [
  {k:'WILD', e:'üíé', pay:[0,0,30,80,100], weight:3, wild:true},
  {k:'SCAT', e:'‚≠ê', pay:[0,0,0,2,5], weight:4, scatter:true},
  {k:'SEVEN',e:'7Ô∏è‚É£', pay:[0,0,8,20,50], weight:6},
  {k:'BELL', e:'üîî', pay:[0,0,5,10,25], weight:8},
  {k:'CHERRY',e:'üçí', pay:[0,0,3,6,15], weight:10},
  {k:'LEMON', e:'üçã', pay:[0,0,2,4,10], weight:12},
  {k:'BAR',  e:'üü©', pay:[0,0,1,2,5], weight:14}
];
const PAYLINES = [
  [0,0,0,0,0], [2,2,2,2,2], [1,1,1,1,1],
  [0,1,2,1,0], [2,1,0,1,2],
  [0,0,1,2,2], [2,2,1,0,0], [1,0,0,0,1], [1,2,2,2,1], [0,1,1,1,2]
];

let strips=[]; // DOM strips
let grid=[];  // current visible 5x3 symbols
let spinning=false, autoLeft=0, freeSpins=0;

function buildReels(){
  reelsEl.innerHTML='';
  strips.length=0;
  for(let c=0;c<COLS;c++){
    const reel=document.createElement('div'); reel.className='reel';
    const strip=document.createElement('div'); strip.className='strip'; strip.style.transform='translateY(0px)';
    // build tall strip with randomized symbols
    const pool=[]; SYMS.forEach(s=>{ for(let i=0;i<s.weight;i++) pool.push(s); });
    const tall=[]; for(let i=0;i<30;i++){ tall.push(pool[Math.floor(Math.random()*pool.length)]); }
    // render many cells
    tall.forEach(sym=>{
      const cell=document.createElement('div'); cell.className='cell'; cell.textContent=sym.e; cell.dataset.k=sym.k; strip.appendChild(cell);
    });
    reel.appendChild(strip); reelsEl.appendChild(reel); strips.push({el:strip, tall});
  }
  // add paylines overlay
  document.querySelectorAll('.payline').forEach(e=>e.remove());
  PAYLINES.forEach((line, idx)=>{
    const y = yFromRow(line[0]);
    const pl=document.createElement('div'); pl.className='payline'; pl.style.top = (y+CELL_H/2)+'px';
    reelsEl.appendChild(pl);
  });
}
function yFromRow(r){ return r* (CELL_H+0) }
function captureGrid(){
  grid = [];
  for(let c=0;c<COLS;c++){
    // read 3 visible at a calculated offset
    const t = parseFloat(getComputedStyle(strips[c].el).transform.split(',')[5]) || 0;
    const off = Math.round(Math.abs(t)/CELL_H)%strips[c].tall.length;
    const arr=[];
    for(let r=0;r<ROWS;r++){
      const idx = (off+r)%strips[c].tall.length;
      arr.push(strips[c].tall[idx]);
    }
    grid.push(arr); // column-wise
  }
}

function displayWin(lines, totalMul){
  // glow boxes on winning cells + payout text + confetti
  document.querySelectorAll('.cell').forEach(c=>c.classList.remove('winCell'));
  const cells = reelsEl.querySelectorAll('.reel');
  lines.forEach(L=>{
    L.indices.forEach(({c,r})=>{
      const idx=( (Math.round(Math.abs(parseFloat(getComputedStyle(strips[c].el).transform.split(',')[5])||0)/CELL_H)%strips[c].tall.length) + r )%strips[c].tall.length;
      const cell = strips[c].el.children[idx]; cell.classList.add('winGlow');
      setTimeout(()=>cell.classList.remove('winGlow'), 1400);
    });
  });
  $('payoutBox').textContent = 'x'+totalMul.toFixed(2);
  confettiBurst(reelsEl.getBoundingClientRect(), Math.min(90, 30+totalMul*3));
}

function computePayout(bet){
  // returns {mul, lines, scatters, freeSpinsAward}
  // Build a simple matrix [r][c] for ease:
  const M = Array.from({length:ROWS}, (_,r)=> Array.from({length:COLS}, (_,c)=> grid[c][r]));
  // scatters
  let scat=0; for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(M[r][c].scatter) scat++;
  let freeAward = (scat>=3)?8:0;

  let totalMul=0, winLines=[];
  for(const line of PAYLINES){
    // evaluate from left to right, substituting wilds
    let base=null, count=0, wildCount=0;
    for(let c=0;c<COLS;c++){
      const r=line[c], sym=M[r][c];
      if(sym.scatter) break; // scatters don‚Äôt count on lines
      if(sym.wild){ wildCount++; count++; continue; }
      if(!base){ base=sym; count++; }
      else if(sym.k===base.k){ count++; }
      else break;
    }
    if(count>=3){
      const effCount = count; // wilds already counted
      // if base is null (line started with wilds), treat highest-paying match behind the wilds: choose best symbol that could form
      if(!base){
        // choose best non-scatter, non-wild
        base = SYMS.filter(s=>!s.scatter && !s.wild).sort((a,b)=>b.pay[effCount]-a.pay[effCount])[0];
      }
      const pay = base.pay[effCount] || 0;
      if(pay>0){
        totalMul += pay;
        const indices=[];
        for(let c=0;c<effCount;c++){ indices.push({c, r:line[c]}); }
        winLines.push({line, count:effCount, base:base.k, pay, indices});
      }
    }
  }
  // scatter pays (small)
  if(scat>=3){ totalMul += SYMS.find(s=>s.scatter).pay[Math.min(5,scat)] || 0; }
  return { mul: totalMul/10, lines:winLines, scatters:scat, freeSpinsAward:freeAward }; // scaled RTP tuning
}

function setStatus(msg){ $('slotStatus').textContent=msg; }

/* Spin animation + fairness */
async function spinOnce(){
  if(spinning) return;
  const bet = Math.max(1, Math.floor(+$('bet').value||0));
  if(store.data.bal<bet && freeSpins<=0){ toast('Insufficient balance'); return; }

  spinning=true; $('spinBtn').disabled=true; $('autoBtn').disabled=true;
  if(freeSpins<=0){ store.data.bal -= bet; updateBal(); }
  else { setStatus(`Free Spins: ${freeSpins}`); freeSpins--; }

  store.data.spins++; $('statSpins').textContent=store.data.spins;
  beep(900,.06,'triangle',.2);

  Fair.nonce++; $('nonce').textContent=String(Fair.nonce);
  // choose outcomes via HMAC per reel stop
  const targets=[];
  for(let c=0;c<COLS;c++){
    const hex = await hmac(Fair.serverSeed, `${Fair.clientSeed}:${Fair.nonce}:SLOTS5X3:${c}`);
    const u = uniFromHex(hex);
    const tall = strips[c].tall;
    const stop = Math.floor(u*tall.length);
    targets.push(stop);
  }

  // animate reels spin with easing + stagger
  const durBase=1200, stagger=140;
  await Promise.all(targets.map((stop,c)=>spinReel(c, stop, durBase + c*stagger)));

  captureGrid();
  const {mul, lines, scatters, freeSpinsAward} = computePayout(bet);
  let win = Math.floor(bet*mul);

  if(win>0){
    store.data.bal += win; updateBal();
    store.data.won += win;
    store.data.biggest = Math.max(store.data.biggest, win);
    $('statBig').textContent = fmt(store.data.biggest);
    setStatus(`Win x${mul.toFixed(2)} ‚Üí +${fmt(win)} ${freeSpinsAward?` ¬∑ +${freeSpinsAward} FS`:''}`);
    displayWin(lines, mul);
    beep(1200,.08,'sine',.25); setTimeout(()=>beep(1400,.08,'sine',.22),120);
    store.pushHistory({t:Date.now(), game:'Slots', bet, win, mul:+mul.toFixed(2)});
  }else{
    setStatus(scatters>=3 ? `Free Spins +${freeSpinsAward}` : 'No win');
    store.pushHistory({t:Date.now(), game:'Slots', bet, win:0, mul:0});
  }
  if(freeSpinsAward) freeSpins += freeSpinsAward;

  $('payoutBox').textContent = win>0 ? `+${fmt(win)}` : '‚Äî';
  $('revealSrv').textContent = Fair.serverSeed; // reveal this pack‚Äôs server seed (for last spin verification)

  // renew pack every 50 spins to keep hashes rotating
  if(Fair.nonce%50===0){ await Fair.newPack(); }

  store.save(); renderMissions(); renderRTP();

  spinning=false; $('spinBtn').disabled=false; $('autoBtn').disabled=false;

  // auto-spin
  if(autoLeft>0){ autoLeft--; setStatus(`Auto: ${autoLeft} left`); if(store.data.bal>0 || freeSpins>0) spinOnce(); else autoLeft=0; }
  else setStatus('Ready');
}

function spinReel(idx, stopIndex, duration){
  return new Promise(res=>{
    const strip = strips[idx];
    const len = strip.tall.length;
    // current offset
    const curY = parseFloat(getComputedStyle(strip.el).transform.split(',')[5])||0;
    // we‚Äôll spin forward several loops then land so that the top cell aligns to stopIndex
    const totalLoops = 2 + idx; // staggered extra loops
    const targetY = -((stopIndex) * CELL_H);
    const extra = -(len*CELL_H*totalLoops);
    const endY = targetY + extra;

    const start=performance.now();
    const easeOutCubic = x=>1-Math.pow(1-x,3);
    function anim(t){
      const p=clamp((t-start)/duration, 0, 1);
      const y = curY + (endY-curY)*easeOutCubic(p);
      strip.el.style.transform = `translateY(${y}px)`;
      // sparks while spinning
      if(Math.random()<.12) spark(reelsEl, idx);
      if(p<1) requestAnimationFrame(anim); else { res(); }
    }
    requestAnimationFrame(anim);
  });
}

/* Particles */
function confettiBurst(rect, n=60){
  for(let i=0;i<n;i++){
    const s=document.createElement('div'); s.className='spark';
    const x = rect.left + rect.width/2, y = rect.top + rect.height/2 + scrollY;
    s.style.left = x+'px'; s.style.top = y+'px';
    document.body.appendChild(s);
    const ang = Math.random()*Math.PI*2, sp = rng(200,800), dur=rng(600,1400);
    const tx = Math.cos(ang)*sp, ty = Math.sin(ang)*sp;
    s.animate([{transform:'translate(0,0)', opacity:1},{transform:`translate(${tx}px, ${ty}px)`, opacity:0}], {duration:dur, easing:'ease-out'}).onfinish=()=>s.remove();
  }
}
function spark(container, cIndex){
  const s=document.createElement('div'); s.className='spark';
  const col = container.children[cIndex];
  const rect = col.getBoundingClientRect();
  s.style.left = (rect.left+rect.width/2)+'px'; s.style.top=(rect.top+rect.height/2+scrollY)+'px';
  document.body.appendChild(s);
  s.animate([{transform:'translateY(0)', opacity:1}, {transform:'translateY(60px)', opacity:0}], {duration:400, easing:'ease-out'}).onfinish=()=>s.remove();
}

/* Auto button */
$('spinBtn').onclick=()=>spinOnce();
$('autoBtn').onclick=()=>{ autoLeft = 25; setStatus(`Auto: ${autoLeft}`); spinOnce(); };

/* =========================
   Runner Rush (endless 3-lane)
========================= */
const runner = $('runner'), Rctx = runner.getContext('2d');
let R = { playing:false, t:0, speed:8, lane:1, y:0, vy:0, sliding:0, score:0, coins:0, lastSpawn:0, magnet:0, shield:0, obstacles:[], pickups:[] };
const LANES=[runner.width*0.28, runner.width*0.5, runner.width*0.72];
const G=0.7, JUMP=12, FLOOR=330;

function rReset(){
  R.playing=false; R.t=0; R.speed=8; R.lane=1; R.y=0; R.vy=0; R.sliding=0; R.score=0; R.coins=0; R.magnet=0; R.shield=0; R.obstacles=[]; R.pickups=[];
  $('rScore').textContent=0; $('rCoins').textContent=0; $('rSpeed').textContent='1.0√ó';
  drawRunner();
}
function drawRunner(){
  // sky
  Rctx.clearRect(0,0,runner.width,runner.height);
  const grd = Rctx.createLinearGradient(0,0,0,runner.height);
  grd.addColorStop(0,'#07131c'); grd.addColorStop(.6,'#0b1a26'); grd.addColorStop(1,'#0e1f2c');
  Rctx.fillStyle=grd; Rctx.fillRect(0,0,runner.width,runner.height);
  // lanes
  for(let i=0;i<3;i++){
    Rctx.strokeStyle='rgba(255,255,255,.06)'; Rctx.lineWidth=2; Rctx.beginPath();
    Rctx.moveTo(LANES[i],0); Rctx.lineTo(LANES[i],runner.height); Rctx.stroke();
  }
  // ground
  Rctx.fillStyle='#0b1620'; Rctx.fillRect(0,FLOOR,runner.width,100);
}
function rSpawn(){
  // spawn obstacle or pickup
  if(R.t - R.lastSpawn < 600) return;
  R.lastSpawn = R.t;
  if(Math.random()<.6){
    // obstacle
    const lane = Math.floor(Math.random()*3);
    const type = Math.random()<.5 ? 'box':'barrier';
    const h = type==='box'?40:60;
    R.obstacles.push({lane, x:runner.width+40, y:FLOOR-h, w:40, h, type});
  }else{
    const lane = Math.floor(Math.random()*3);
    const kind = Math.random()<.7 ? 'coin' : (Math.random()<.5?'magnet':'shield');
    const y = kind==='coin' ? FLOOR-80 : FLOOR-120;
    R.pickups.push({lane, x:runner.width+40, y, w:26, h:26, kind});
  }
}
function rUpdate(dt){
  R.t += dt;
  R.speed += 0.0007*dt; // ramp up
  $('rSpeed').textContent = (R.speed/8).toFixed(1)+'√ó';

  // player physics
  R.vy += G; R.y += R.vy; if(R.y>0){ R.y=0; R.vy=0; }
  if(R.sliding>0) R.sliding-=dt;

  // spawn
  if(R.playing) rSpawn();

  // move entities
  const vx = R.speed;
  for(const o of R.obstacles) o.x -= vx;
  for(const p of R.pickups) p.x -= vx;
  // cleanup
  R.obstacles = R.obstacles.filter(o=>o.x>-80);
  R.pickups = R.pickups.filter(p=>p.x>-80);

  // collisions
  const px = LANES[R.lane], py = FLOOR-40 + R.y, pw = 36, ph = R.sliding>0 ? 20 : 40;
  for(const o of R.obstacles){
    const ox = LANES[o.lane]-20 + (o.x - runner.width*0.5), oy=o.y, ow=o.w, oh=o.h;
    if(Math.abs((px-18) - (LANES[o.lane]-20 + (o.x - runner.width*0.5)))<28 && Math.abs(py - oy)<(ph+oh)/2){
      if(R.shield>0){ R.shield=0; beep(500,.08,'sawtooth'); o.x=-999; } else { rGameOver(); return; }
    }
  }
  for(const p of R.pickups){
    const ox = LANES[p.lane]-13 + (p.x - runner.width*0.5), oy=p.y, ow=p.w, oh=p.h;
    if(Math.abs((px-18) - (LANES[p.lane]-13 + (p.x - runner.width*0.5)))<24 && Math.abs(py - oy)<(ph+oh)/2){
      if(p.kind==='coin'){ R.coins++; $('rCoins').textContent=R.coins; beep(1100,.05,'sine'); }
      if(p.kind==='magnet'){ R.magnet = 4000; toast('üîµ Magnet!'); }
      if(p.kind==='shield'){ R.shield = 1; toast('üü¢ Shield!'); }
      p.x=-999;
    }
  }
  // magnet effect
  if(R.magnet>0){
    for(const p of R.pickups){
      if(p.kind==='coin'){
        const targetX = LANES[R.lane]-13 + (p.x - runner.width*0.5);
        const targetY = FLOOR-40 + R.y;
        const dx = targetX - (LANES[p.lane]-13 + (p.x - runner.width*0.5));
        const dy = targetY - p.y;
        p.x += dx*0.02; p.y += dy*0.02;
      }
    }
    R.magnet -= dt;
  }

  // score
  if(R.playing){ R.score += Math.floor(vx*0.04); $('rScore').textContent = R.score; }
}
function rRender(){
  drawRunner();
  // draw entities
  // obstacles
  for(const o of R.obstacles){
    const x = o.x; const laneX = LANES[o.lane]; const drawX = laneX + (x - runner.width*0.5);
    Rctx.fillStyle = '#ff6363'; Rctx.fillRect(drawX-20, o.y, o.w, o.h);
  }
  // pickups
  for(const p of R.pickups){
    const x=p.x; const laneX=LANES[p.lane]; const drawX = laneX + (x - runner.width*0.5);
    if(p.kind==='coin'){ Rctx.fillStyle='#ffd166'; Rctx.beginPath(); Rctx.arc(drawX, p.y, 13, 0, Math.PI*2); Rctx.fill(); }
    else if(p.kind==='magnet'){ Rctx.fillStyle='#66d1ff'; Rctx.fillRect(drawX-13, p.y-13, 26, 26); }
    else { Rctx.fillStyle='#6bff8d'; Rctx.beginPath(); Rctx.arc(drawX, p.y, 14,0,Math.PI*2); Rctx.fill(); }
  }
  // player
  const px = LANES[R.lane], py = FLOOR-40 + R.y;
  Rctx.save();
  Rctx.translate(px, py);
  Rctx.fillStyle='#9cf';
  Rctx.fillRect(-18, - (R.sliding>0?10:20), 36,(R.sliding>0?20:40));
  if(R.shield>0){ Rctx.strokeStyle='rgba(102,255,153,.6)'; Rctx.lineWidth=3; Rctx.beginPath(); Rctx.arc(0,-10,28,0,Math.PI*2); Rctx.stroke(); }
  Rctx.restore();
}
let raf=null, prevT=0;
function loop(t){
  const dt = Math.min(34, t - (prevT||t)); prevT=t;
  if(R.playing){ rUpdate(dt); rRender(); }
  raf=requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function rGameOver(){
  R.playing=false; beep(240,.12,'sawtooth'); toast('üí• Crash! Coins added to balance.');
  // award coins ‚Üí balance (1 coin = 5)
  const add = R.coins*5; store.data.bal += add; updateBal(); store.pushHistory({t:Date.now(), game:'Runner', bet:0, win:add, mul:0});
  store.save(); renderMissions();
}
$('rStart').onclick=()=>{ if(!R.playing){ rReset(); R.playing=true; } };
$('rPause').onclick=()=>{ R.playing=!R.playing; };
$('rHelp').onclick=()=>{ alert('Runner Rush Controls:\n‚Ä¢ Swipe/Arrow Left/Right: change lane\n‚Ä¢ Swipe Up / Space: jump\n‚Ä¢ Swipe Down / Shift: slide\nCollect coins, avoid obstacles. Magnet pulls coins, Shield blocks one hit.'); };

function laneLeft(){ R.lane = clamp(R.lane-1,0,2); beep(800,.04); }
function laneRight(){ R.lane = clamp(R.lane+1,0,2); beep(800,.04); }
function jump(){ if(R.y===0){ R.vy=-JUMP; beep(1000,.05); } }
function slide(){ if(R.y===0){ R.sliding=400; beep(700,.04); } }
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft') laneLeft();
  if(e.key==='ArrowRight') laneRight();
  if(e.key===' ' || e.key==='Spacebar') jump();
  if(e.key==='ArrowDown' || e.key==='Shift') slide();
});
// touch/swipe
(function(){
  let sx=0, sy=0, t0=0;
  runner.addEventListener('touchstart',e=>{ const t=e.touches[0]; sx=t.clientX; sy=t.clientY; t0=performance.now(); }, {passive:true});
  runner.addEventListener('touchend',e=>{
    const dx=(e.changedTouches[0].clientX - sx), dy=(e.changedTouches[0].clientY - sy);
    const ax=Math.abs(dx), ay=Math.abs(dy);
    if(Math.max(ax,ay)<20) return;
    if(ax>ay) (dx>0?laneRight():laneLeft());
    else (dy<0?jump():slide());
  }, {passive:true});
})();

/* =========================
   Missions & Leaderboard & Recent
========================= */
const MISSIONS = [
  {id:'slots10', text:'Complete 10 spins', goal:10, type:'spins'},
  {id:'bigwin', text:'Win ‚â• 10,000 in a single spin', goal:10000, type:'big'},
  {id:'runner100', text:'Collect 100 coins in Runner', goal:100, type:'runnerCoins'}
];
function renderMissions(){
  const M = store.data.missions||{};
  $('missions').innerHTML='';
  MISSIONS.forEach(m=>{
    let progress=0;
    if(m.type==='spins') progress=store.data.spins;
    if(m.type==='big') progress=store.data.biggest;
    if(m.type==='runnerCoins') progress = Math.max( ...(store.data.history.filter(h=>h.game==='Runner').map(h=>h.win/5)), 0);
    const done = progress>=m.goal;
    const row=document.createElement('div');
    row.innerHTML = `<div class="row"><span class="badge">${m.text}</span><span class="badge">${Math.min(progress,m.goal)} / ${m.goal}</span>${done?'<span class="badge" style="background:#0f2b18;border-color:#17653e;color:#9fffbf">Done</span>':''}</div>`;
    $('missions').appendChild(row);
  });
}
function renderRecent(){
  const r=$('recent'); r.innerHTML='';
  store.data.history.forEach(h=>{
    const d=document.createElement('div');
    const t=new Date(h.t).toLocaleTimeString();
    d.innerHTML = `<span class="sub">${t}</span> ¬∑ <b>${h.game}</b> ‚Äî ${h.win>0?`<span style="color:#aaffcc">+${fmt(h.win)}</span>`:`<span style="color:#ff9ea0">‚àí${fmt(h.bet)}</span>`}${h.mul?` (x${h.mul})`:''}`;
    r.appendChild(d);
  });
}
function renderLB(){
  const lb=$('lb'); lb.innerHTML='';
  store.data.leaderboard.forEach((row,i)=>{
    const d=document.createElement('div');
    d.innerHTML = `<b>#${i+1}</b> ¬∑ <span style="color:#9cf">${row.name}</span> ‚Äî <b>${fmt(row.score)}</b> <span class="sub">(${row.time})</span>`;
    lb.appendChild(d);
  });
}
function renderRTP(){
  const totalIn = store.data.spins * store.data.bet; // approximate for display (not exact if bet changed)
  const rtp = totalIn>0 ? (store.data.won/totalIn)*100 : 0;
  $('statRTP').textContent = rtp? rtp.toFixed(1)+'%':'‚Äî';
}

/* =========================
   Boot
========================= */
function refreshAll(){
  updateBal();
  $('bet').value=store.data.bet;
  $('statSpins').textContent=store.data.spins;
  $('statBig').textContent=fmt(store.data.biggest);
  renderRecent(); renderLB(); renderMissions(); renderRTP();
}
async function boot(){
  store.load(); SFX_ON=store.data.sfx;
  applyTheme();
  buildReels();
  await Fair.newPack();
  refreshAll();
}
boot();
</script>
</body>
</html>
