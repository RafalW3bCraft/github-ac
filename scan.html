<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mythic Eyes: Emotion Awakening</title>
<style>
body{margin:0;overflow:hidden;background:#000;color:#fff;font-family:sans-serif}
video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
#video{transform:scaleX(-1)} /* mirror selfie */
#status{position:fixed;top:8px;left:50%;transform:translateX(-50%);
  background:#0008;padding:6px 10px;border-radius:8px;font-size:14px}
#persona{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);
  background:#0008;padding:8px 12px;border-radius:10px;display:flex;gap:8px}
#persona button{padding:6px 12px;border:1px solid #666;border-radius:8px;
  background:#111;color:#fff;cursor:pointer}
#persona button.active{border-color:#ffd166;color:#ffd166}
#gallery{position:fixed;top:50px;right:10px;max-height:80%;overflow-y:auto;
  display:flex;flex-direction:column;gap:6px}
#gallery img{width:100px;border:2px solid #666;border-radius:6px}
</style>
</head>
<body>
<video id="video" autoplay playsinline muted></video>
<canvas id="fx"></canvas>
<div id="status">Loadingâ€¦</div>
<div id="persona">
  <button data-p="zeus">âš¡ Zeus</button>
  <button data-p="hera">ðŸŒ™ Hera</button>
  <button data-p="hades">ðŸ’€ Hades</button>
</div>
<div id="gallery"></div>

<script type="module">
import {FaceLandmarker, FilesetResolver} from 
  "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/vision_bundle.mjs";

const video=document.getElementById("video");
const fx=document.getElementById("fx"), ctx=fx.getContext("2d");
const status=document.getElementById("status");
const personaBtns=document.querySelectorAll("#persona button");
const gallery=document.getElementById("gallery");

let landmarker,lastVideoTime=0,currentPersona="zeus";

const COLORS={
  zeus:"#00f5ff",hera:"#ff3d81",hades:"#9b59b6"
};

// persona switching
personaBtns.forEach(b=>{
  b.onclick=()=>{
    personaBtns.forEach(x=>x.classList.remove("active"));
    b.classList.add("active"); currentPersona=b.dataset.p;
  };
});
personaBtns[0].classList.add("active");

// init face
async function initFace(){
  const fileset=await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm");
  landmarker=await FaceLandmarker.createFromOptions(fileset,{
    baseOptions:{modelAssetPath:
      "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm/face_landmarker.task"},
    runningMode:"VIDEO",numFaces:1,outputFaceBlendshapes:true
  });
  status.textContent="Face model ready";
}

// camera
async function openCamera(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
    video.srcObject=stream;
    video.onloadedmetadata=()=>{
      video.play();
      fx.width=video.videoWidth; fx.height=video.videoHeight;
      status.textContent="Camera ready";
      requestAnimationFrame(loop);
    };
  }catch(e){status.textContent="Camera denied";}
}

// render
function renderFX(landmarks){
  ctx.clearRect(0,0,fx.width,fx.height);
  if(!landmarks?.length) return;
  const pts=landmarks[0];
  const L=pts[468]||pts[159],R=pts[473]||pts[386];
  if(!L||!R) return;
  const lx=L.x*fx.width,ly=L.y*fx.height;
  const rx=R.x*fx.width,ry=R.y*fx.height;
  const color=COLORS[currentPersona]||"#ffd166";
  drawGlow(lx,ly,color);
  drawGlow(rx,ry,color);
  drawAura((lx+rx)/2,(ly+ry)/2,color);
  if(Math.random()<0.05) spark(lx,ly,color);
  if(Math.random()<0.05) spark(rx,ry,color);
}
function drawGlow(x,y,color){
  const r=32,g=ctx.createRadialGradient(x,y,6,x,y,r);
  g.addColorStop(0,color); g.addColorStop(1,"transparent");
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,2*Math.PI); ctx.fill();
}
function drawAura(x,y,color){
  const r=120,g=ctx.createRadialGradient(x,y,20,x,y,r);
  g.addColorStop(0,color+"66"); g.addColorStop(1,"transparent");
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,2*Math.PI); ctx.fill();
}
function spark(x,y,color){
  ctx.fillStyle=color;
  ctx.beginPath(); ctx.arc(x+rng(-10,10),y+rng(-10,10),rng(2,5),0,2*Math.PI); ctx.fill();
}
const rng=(a,b)=>Math.random()*(b-a)+a;

// loop
function loop(){
  if(video.readyState>=2&&landmarker){
    if(video.currentTime!==lastVideoTime){
      lastVideoTime=video.currentTime;
      const res=landmarker.detectForVideo(video,performance.now());
      renderFX(res.faceLandmarks);
    }
  }
  requestAnimationFrame(loop);
}

// capture to gallery (tap canvas)
fx.onclick=()=>{
  const img=new Image();
  img.src=fx.toDataURL("image/png");
  gallery.prepend(img);
};

(async function(){
  await initFace();
  await openCamera();
})();
</script>
</body>
</html>
